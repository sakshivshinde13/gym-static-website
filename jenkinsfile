pipeline {
 agent any

 environment {
  SERVER_IP = '172.31.41.135'
  SSH_CREDENTIAL = 'gym-test-key'
  REPO_URL = 'https://github.com/sakshivshinde13/gym-static-website.git'
  BRANCH = 'main'
  REMOTE_USER = 'ubuntu'
  REMOTE_PATH = '/var/www/html'
 }

 stages {

  stage('Clone Repository') {
   steps {
    git branch: "${BRANCH}", url: "${REPO_URL}"
   }
  }
stage('Prepare Deployment Directory') {
   steps {
    sshagent([SSH_CREDENTIAL]) {
     sh """
      ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP}'
        sudo mkdir -p ${REMOTE_PATH}
        sudo chown -R ${REMOTE_USER}:${REMOTE_USER} ${REMOTE_PATH}
      '
     """
    }
   }
  }

 stage('Deploy Website') {
   steps {
    sshagent([SSH_CREDENTIAL]) {
     sh """
      scp -o StrictHostKeyChecking=no -r * ${REMOTE_USER}@${SERVER_IP}:${REMOTE_PATH}
     """
    }
   }
  }

  stage('Restart Nginx') {
   steps {
    sshagent([SSH_CREDENTIAL]) {
     sh """
      ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} '
        sudo systemctl restart nginx
      '
     """
    }
   }
  }
 }

 post {
  success {
   echo 'Deployment Successful üéâ'
  }
  failure {
   echo 'Deployment Failed ‚ùå'
  }
 }
}