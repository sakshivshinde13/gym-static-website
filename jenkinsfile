pipeline {
 agent any

 environment {
  SERVER_IP = '172.31.41.135'      // Private IP of your EC2
  SSH_CREDENTIAL = 'gym-test-key'  // Jenkins credential ID
  REPO_URL = 'https://github.com/sakshivshinde13/gym-static-website.git'
  BRANCH = 'main'
  REMOTE_USER = 'ubuntu'
  REMOTE_PATH = '/var/www/html'
 }

 stages {

  stage('Clone Repository') {
   steps {
    git branch: "${BRANCH}", url: "${REPO_URL}"
   }
  }

  stage('Prepare & Start Nginx') {
   steps {
    sshagent([SSH_CREDENTIAL]) {
     sh """
      ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} '
        echo "Updating system packages..."
        sudo apt update -y && sudo apt upgrade -y

        echo "Installing Nginx if not installed..."
        if ! command -v nginx >/dev/null 2>&1; then
          sudo apt install nginx -y
        fi

        echo "Starting Nginx service..."
        sudo systemctl enable nginx
        sudo systemctl start nginx

        echo "Preparing deployment directory..."
        sudo mkdir -p ${REMOTE_PATH}
        sudo chown -R ${REMOTE_USER}:${REMOTE_USER} ${REMOTE_PATH}
      '
     """
    }
   }
  }

  stage('Deploy to Target Server') {
   steps {
    sshagent([SSH_CREDENTIAL]) {
     sh """
      scp -o StrictHostKeyChecking=no -r * ${REMOTE_USER}@${SERVER_IP}:${REMOTE_PATH}
     """
    }
   }
  }

  stage('Restart Nginx') {
   steps {
    sshagent([SSH_CREDENTIAL]) {
     sh """
      ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} '
        echo "Restarting Nginx..."
        sudo systemctl restart nginx
      '
     """
    }
   }
  }
 }

 post {
  success {
   echo 'Deployment Successful üéâ'
  }
  failure {
   echo 'Deployment Failed ‚ùå'
  }
 }
}